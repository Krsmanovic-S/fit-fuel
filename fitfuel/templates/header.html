{% extends 'base.html ' %}
{% load static %}
{% block content %}
<header class="header">    
    <div class="header-brand">
        <img class="logo-img" src="{% static 'img/logo.png' %}" alt="Fit Fuel Logo">
        <a href="{% url 'index' %}" class="header-brand__name">Fit-Fuel</a>
    </div>
    <div class="user-nav">
        <a class="nav-button" href="{% url 'menu' %}">Menu</a>
        <a class="nav-button" href="#">Discounts</a>
        <a class="nav-button" href="#">Contact</a>
    </div>
    <div class="icon-container">
        <a class="icon-link" id="cart" href="#" data-bs-custom-class="custom-popover">
            <i class="fi fi-rs-shopping-cart-add"></i>
        </a>

        <div class="dropdown">
            <a class="icon-link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fi fi-rs-user"></i>
            </a>

            <ul class="dropdown-menu">
                {% if not user.is_authenticated %}
                <li><a class="dropdown-item" href="{% url 'login' %}">Login</a></li>
                <li><a class="dropdown-item" href="{% url 'register' %}">Register</a></li>
                {% else %}
                <li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
                <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                {% endif %}
            </ul>
        </div>

        <span id="cart-number" class="icon-container__cart">0</span>
    </div>
</header>


<script type="text/javascript">

let cart = {}; 
let cartPopoverInstance; 
let cartNumber;

// Update all Macros based on selected Portion
function updateItemMacros(selectedRadio) {
    const itemContainer = selectedRadio.closest('.item-container');
    const macrosDisplayElements = {
        carbs: itemContainer.querySelector('[data-type="carbs"]'),
        proteins: itemContainer.querySelector('[data-type="protein"]'),
        fats: itemContainer.querySelector('[data-type="fats"]'),
        calories: itemContainer.querySelector('[data-type="calories"]')
    };
    const carbs = selectedRadio.dataset.carbs || '0';
    const proteins = selectedRadio.dataset.proteins || '0';
    const fats = selectedRadio.dataset.fats || '0';
    const calories = selectedRadio.dataset.calories || '0';

    macrosDisplayElements.carbs.textContent = "Carbs: " + carbs + "g";
    macrosDisplayElements.proteins.textContent = "Protein: " + proteins + "g";
    macrosDisplayElements.fats.textContent = "Fats: " + fats + "g";
    macrosDisplayElements.calories.textContent = "Kcal: " + calories;
}

// Updating Cart Display
function updateCartDisplay() {
    let currentCartState = JSON.parse(localStorage.getItem('cart'));
    if (!currentCartState) {
        cartPopoverInstance.setContent({
            '.popover-header': 'Cart',
            '.popover-body': 'Your cart is empty.'
        });
        return;
    }
    
    let cartString = '';
    let totalUniqueItems = 0;
    let totalQuantity = 0;

    for (const itemID in currentCartState) { 
        const cartEntry = currentCartState[itemID];
        const itemDetails = cartEntry[0]; 
        const quantity = cartEntry[1];     

        totalQuantity += quantity; 

        // Truncate the name so it can fit better
        displayName = itemDetails.name;
        if (displayName.length > 20) {
            displayName = displayName.substring(0, 20) + '...';
        }

        cartString += 
        `
            <div class="item-layout">
                <img class="item-layout__image" src="${itemDetails.image}" alt="Cart Entry Image">
                <div class="item-layout__info">
                    <p class="item-layout__info-name">${displayName}</p>

                    <div class="item-layout__info-type">
                        <div class="item-layout__info-type-portion">${itemDetails.portion_name}</div>

                        <div class="item-layout__info-type-actions">
                            <p class="item-layout__info-type-actions-value">x${quantity}</p>
                            <a href="#" id="${itemID}" class="item-layout__info-type-actions-remove">-</a>
                            <p class="item-layout__info-type-actions-price">${itemDetails.price}€</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    cartString +=
    `
        <a id="checkout-button" class="nav-button" href="#">Checkout</>
    `;
    
    // Only use setContent if the popover isn't shown, this is to avoid shown popover flickering
    const popoverElement = document.querySelector('.popover-body');
    if (popoverElement) {
        popoverElement.innerHTML = cartString;
    } else {
        cartPopoverInstance.setContent({
            '.popover-header': 'Cart',
            '.popover-body': cartString
        });
    }
    
    cartNumber.innerHTML = totalQuantity;
}

// Adding items to the Cart
function addToCart(buttonElement, event) {
    event.preventDefault();

    const itemContainer = buttonElement.closest('.item-container');
    const selectedPortionRadio = itemContainer.querySelector('input[name="selected_portion"]:checked');
    if (selectedPortionRadio) {

        const portionID = selectedPortionRadio.id.replace('portion-', '');

        const priceSpan = selectedPortionRadio.nextElementSibling.querySelector('.item-container__portion-container-option__price');
        const finalPrice = parseFloat(priceSpan.textContent.replace('€', '').trim());

        if(cart[portionID] === undefined) {
            // Anchor tag stores all menu item information for frontend display
            const anchorTag = buttonElement.querySelector('a');

            const portionName = selectedPortionRadio.nextElementSibling.querySelector('.item-container__portion-container-option__name').textContent

            const itemProperties = {
                'image': anchorTag.dataset.image,
                'name': anchorTag.dataset.name,
                'price': finalPrice,
                'portion_name': portionName
            };

            console.log(itemProperties.portion_name)
            cart[portionID] = [itemProperties, 1];
        }
        else {
            cart[portionID][1] += 1;
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }    
}

async function proceedToCheckout(event) {
    event.preventDefault();

    console.log("JS DEBUG: 'proceedToCheckout' function entered.");
    
    const currentLocalStorageCartRaw = localStorage.getItem('cart');
    console.log("JS DEBUG: Raw localStorage 'cart' before processing:", currentLocalStorageCartRaw);

    const cartJsonData = currentLocalStorageCartRaw;
    const cartData = cartJsonData ? JSON.parse(cartJsonData) : {};

    console.log("JS DEBUG: Parsed cartData from localStorage (to be sent to server):", cartData);

    if (Object.keys(cartData).length === 0) {
        console.warn("JS DEBUG: Cart data from localStorage is empty. Not sending empty cart to server.");
        alert("Your cart is empty! Please add items before checking out.");
        const checkoutButton = event.target.closest('#checkout-button');
        if (checkoutButton) {
            checkoutButton.disabled = false;
            checkoutButton.textContent = 'Checkout';
        }
        return;
    }

    const checkoutButton = event.target.closest('#checkout-button');
    if (checkoutButton) {
        checkoutButton.disabled = true;
        checkoutButton.textContent = 'Processing...';
    }

    try {
        // --- MODIFICATION START ---
        // POST to the new update API endpoint
        console.log("JS DEBUG: Attempting to send POST request to {% url 'update_session_cart' %}");
        const response = await fetch('{% url "update_session_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': csrftoken // Uncomment and ensure csrftoken is defined in production
            },
            body: JSON.stringify({ cart: cartData })
        });
        // --- MODIFICATION END ---

        console.log("JS DEBUG: Received response from server. Status:", response.status);

        const responseText = await response.text(); 
        console.log("JS DEBUG: Raw response text from API:", responseText);

        let responseData = {};
        try {
            responseData = JSON.parse(responseText);
        } catch (jsonError) {
            console.error("JS DEBUG: Failed to parse response from API as JSON:", jsonError);
            console.error("JS DEBUG: Non-JSON response received from API. This could be an error page or a misconfigured server response.");
            alert('Server returned an unexpected response from API. Please check console for details.');
            throw new Error('Non-JSON response from server API.');
        }

        if (response.ok) {
            console.log("JS DEBUG: Cart data sent and processed successfully by update API.");
            console.log("JS DEBUG: Server response data from API:", responseData);
            
            // --- MODIFICATION START ---
            // Redirect to the new GET-only checkout display page
            window.location.href = '{% url "checkout_page" %}';
            // --- MODIFICATION END ---

        } else {
            console.error("JS DEBUG: Server returned an error from API (response.ok is false). Status:", response.status);
            console.error("JS DEBUG: Server message from API:", responseData.message || "No specific message.");
            alert('Error updating cart on server: ' + (responseData.message || `Server responded with status ${response.status}.`));
            if (checkoutButton) {
                checkoutButton.disabled = false;
                checkoutButton.textContent = 'Checkout';
            }
        }
    } catch (error) {
        console.error("JS DEBUG: Network or unexpected error during checkout process (API call):", error);
        alert('An unexpected error occurred during cart sync. Please try again. Check browser console for more details.');
        if (checkoutButton) {
            checkoutButton.disabled = false;
            checkoutButton.textContent = 'Checkout';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        cart = JSON.parse(localStorage.getItem('cart')) || {}; 
    } catch (e) {
        console.error("Error parsing cart from localStorage:", e);
        cart = {};
    }
 
    const cartPopoverElement = document.getElementById('cart');
    cartPopoverInstance = bootstrap.Popover.getInstance(cartPopoverElement);
    if (!cartPopoverInstance) {
        cartPopoverInstance = new bootstrap.Popover(cartPopoverElement, {
            html: true,
            content: 'Your cart is empty.',
            trigger: 'focus',  
            placement: 'bottom'
        });
    }

    cartNumber = document.getElementById('cart-number');

    // Binding Portion Radios for Macros
    const portionRadioButtons = document.getElementsByName('selected_portion');
    Array.from(portionRadioButtons).forEach(radio => {
        radio.addEventListener('change', function() { updateItemMacros(this); });
    });

    const allInitiallyCheckedRadios = document.querySelectorAll('input[type="radio"]:checked');
    allInitiallyCheckedRadios.forEach(radio => {
        radio.addEventListener('change', function() { updateItemMacros(this); });
        updateItemMacros(radio); 
    });

    // Binding Add-to-Cart Buttons
    const cartButtons = document.querySelectorAll('.item-container__cart-button');
    cartButtons.forEach(buttonElement => {
        buttonElement.addEventListener('click', function(event) { addToCart(this, event); });
    });

    // Initial Cart Display
    updateCartDisplay();

    // Binding event for Remove Buttons in the cart
    document.body.addEventListener('click', function (event) {
        const removeButton = event.target.closest('.item-layout__info-amount-quantity-remove');
        if (!removeButton) return;

        event.preventDefault();
        const itemID = removeButton.id;

        if (cart[itemID]) {
            cart[itemID][1]--; 

            if (cart[itemID][1] <= 0) {
                delete cart[itemID];
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay(); 
        }
    });

    // Binding the Checkout Button
    document.body.addEventListener('click', (event) => {
        const checkoutButton = event.target.closest('#checkout-button');
        if (checkoutButton) {
            proceedToCheckout(event); 
        }
    });

});

</script>

{% endblock %}