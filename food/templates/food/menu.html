{% extends 'base.html' %}
{% load static %}
{% block title %}FitFuel - Menu{% endblock %}
{% block content %}
{% include 'header.html' %}

<div class="menu-container">
    {% for category in menu_categories %}
        <div class="category-container">
            <div class="category-container__title">{{ category.name }}</div>

            <div class="category-container__decal">
                <div class="horizontal-lines">
                    <hr class="line">
                    <hr class="line">
                </div>

                <div class="category_badge">
                    <img src="{% static 'categories/frame.png' %}" alt="Category Badge Frame" class="category_badge__frame">
                    <img src="{{ category.image_url }}" alt="Category Icon" class="category_badge__category-icon">
                </div>

                <div class="horizontal-lines">
                    <hr class="line">
                    <hr class="line">
                </div>
            </div>
        </div>

        <div class="menu-item-grid">
            {% for item in menu_items %}
                {% if item.category.id == category.id %}
                <div class="item-container">

                    <div class="item-container__item-image">
                        <img src="{{ item.image_url }}" alt="Food Item Image" class="item-image">
                    </div>

                    <div class="item-container__title">{{ item.name }}</div>

                    <div class="item-container__macros">
                        <div class="item-container__macros-carbs custom-pill" data-type="carbs">Carbs: 35g</div>
                        <div class="item-container__macros-protein custom-pill" data-type="protein">Protein: 20g</div>
                        <div class="item-container__macros-fats custom-pill" data-type="fats">Fats: 15g</div>
                        <div class="item-container__macros-calories custom-pill" data-type="calories">Kcal: 380</div>
                    </div>

                    <div class="item-container__item-description">{{ item.description }}</div>

                    <form class="item-container__portion-container">
                        {% for portion in item.portions.all %}
                            {% with calculated_macros=portion.calculate_macros_for_portion %}
                            <div class="item-container__portion-container-option">
                                <input type="radio" id="portion-{{ portion.id }}" name="selected_portion" 
                                       value="{{ portion.id }}" {% if forloop.first %}checked{% endif %}
                                       data-carbs="{{ calculated_macros.carbs }}" data-proteins="{{ calculated_macros.protein }}"
                                       data-fats="{{ calculated_macros.fats }}" data-calories="{{ calculated_macros.calories }}">
                                <label for="portion-{{ portion.id }}">
                                    <span class="item-container__portion-container-option__name">{{ portion.name }}</span>
                                    <span class="item-container__portion-container-option__price">{{ portion.price }}€</span>
                                </label>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </form>

                    <div class="item-container__cart-button">
                        <a id="{{ item.id }}" href="#" data-image="{{ item.image_url }}" data-name="{{ item.name }}">Add to Cart</a>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
</div>

{% include 'footer.html' %}

<script type="text/javascript">

let cart = {}; 
let cartPopoverInstance; 
let cartNumber;

// Update all Macros based on selected Portion
function updateItemMacros(selectedRadio) {
    const itemContainer = selectedRadio.closest('.item-container');
    const macrosDisplayElements = {
        carbs: itemContainer.querySelector('[data-type="carbs"]'),
        proteins: itemContainer.querySelector('[data-type="protein"]'),
        fats: itemContainer.querySelector('[data-type="fats"]'),
        calories: itemContainer.querySelector('[data-type="calories"]')
    };
    const carbs = selectedRadio.dataset.carbs || '0';
    const proteins = selectedRadio.dataset.proteins || '0';
    const fats = selectedRadio.dataset.fats || '0';
    const calories = selectedRadio.dataset.calories || '0';

    macrosDisplayElements.carbs.textContent = "Carbs: " + carbs + "g";
    macrosDisplayElements.proteins.textContent = "Protein: " + proteins + "g";
    macrosDisplayElements.fats.textContent = "Fats: " + fats + "g";
    macrosDisplayElements.calories.textContent = "Kcal: " + calories;
}

// Updating Cart Display
function updateCartDisplay() {
    let currentCartState = JSON.parse(localStorage.getItem('cart'));
    if (!currentCartState) return;

    let cartString = '';
    let totalUniqueItems = 0;
    let totalQuantity = 0;

    for (const itemID in currentCartState) { 
        const cartEntry = currentCartState[itemID];
        const itemDetails = cartEntry[0]; 
        const quantity = cartEntry[1];     

        totalQuantity += quantity; 

        // Truncate the name so it can fit better
        displayName = itemDetails.name;
        if (displayName.length > 20) {
            displayName = displayName.substring(0, 20) + '...';
        }

        cartString += 
        `
            <div class="item-layout">
                <img class="item-layout__image" src="${itemDetails.image}" alt="Cart Entry Image">
                <div class="item-layout__info">
                    <p class="item-layout__info-name">${displayName}</p>
                    <div class="item-layout__info-amount">
                        <div class="item-layout__info-amount-quantity">
                            <p class="item-layout__info-amount-quantity-value">x${quantity}</p>
                            <a href="#" id="${itemID}" class="item-layout__info-amount-quantity-remove">-</a>
                        </div>
                        <p class="item-layout__info-amount-price">${itemDetails.price}€</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Only use setContent if the popover isn't shown, this is to avoid shown popover flickering
    const popoverElement = document.querySelector('.popover-body');
    if (popoverElement) {
        popoverElement.innerHTML = cartString;
    } else {
        cartPopoverInstance.setContent({
            '.popover-header': 'Cart',
            '.popover-body': cartString
        });
    }
    
    cartNumber.innerHTML = totalQuantity;
}

// --- ADD TO CART FUNCTION ---
function addToCart(buttonElement, event) {
    event.preventDefault();

    const anchorTag = buttonElement.querySelector('a');
    const itemID = anchorTag.id.toString();

    if(cart[itemID] === undefined) {
        const itemContainer = buttonElement.closest('.item-container');
        let finalPrice = 0;

        const selectedPortionRadio = itemContainer.querySelector('input[name="selected_portion"]:checked');
        if (selectedPortionRadio) {
            const priceSpan = selectedPortionRadio.nextElementSibling.querySelector('.item-container__portion-container-option__price');
    
            finalPrice = parseFloat(priceSpan.textContent.replace('€', '').trim());
        } 

        const itemProperties = {
            'image': anchorTag.dataset.image,
            'name': anchorTag.dataset.name,
            'price': finalPrice
        };
        
        cart[itemID] = [itemProperties, 1];
    }
    // Otherwise increment the amount by 1
    else {
        cart[itemID][1] += 1;
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        cart = JSON.parse(localStorage.getItem('cart')) || {}; 
    } catch (e) {
        console.error("Error parsing cart from localStorage:", e);
        cart = {};
    }
 
    const cartPopoverElement = document.getElementById('cart');
    cartPopoverInstance = bootstrap.Popover.getInstance(cartPopoverElement);
    if (!cartPopoverInstance) {
        cartPopoverInstance = new bootstrap.Popover(cartPopoverElement, {
            html: true,
            content: 'Your cart is empty.',
            trigger: 'click',  
            placement: 'bottom'
        });
    }

    cartNumber = document.getElementById('cart-number');

    // Binding Portion Radios for Macros
    const portionRadioButtons = document.getElementsByName('selected_portion');
    Array.from(portionRadioButtons).forEach(radio => {
        radio.addEventListener('change', function() { updateItemMacros(this); });
    });

    const allInitiallyCheckedRadios = document.querySelectorAll('input[type="radio"]:checked');
    allInitiallyCheckedRadios.forEach(radio => {
        radio.addEventListener('change', function() { updateItemMacros(this); });
        updateItemMacros(radio); 
    });

    // Binding Add-to-Cart Buttons
    const cartButtons = document.querySelectorAll('.item-container__cart-button');
    cartButtons.forEach(buttonElement => {
        buttonElement.addEventListener('click', function(event) { addToCart(this, event); });
    });

    // Initial Cart Display
    updateCartDisplay();

    document.body.addEventListener('click', function (event) {
        const removeButton = event.target.closest('.item-layout__info-amount-quantity-remove');
        if (!removeButton) return;

        event.preventDefault();
        const itemID = removeButton.id;

        if (cart[itemID]) {
            cart[itemID][1]--; 

            if (cart[itemID][1] <= 0) {
                delete cart[itemID];
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay(); 
        }
    });
});

</script>

{% endblock %}

